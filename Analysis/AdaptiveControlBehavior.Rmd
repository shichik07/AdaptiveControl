---
title: "AdaptiveControlBehavior"
author: "Julius Kricheldorff"
date: "3/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dbplyr)
library(tidyverse)
library(brms)
library(lme4)
library(car)
library(optimx)
```
remove.packages('dbplyr', '/home/jules/R/x86_64-pc-linux-gnu-library/4.1')
## Load Data
```{r}
set.seed(33940)

#filename <- "/home/jules/Dropbox/PhD_Thesis/Adaptive_Control/Pilot+/Data/Old_Young_behav/OldYoung_only.csv"
filename <- "/home/jules/Dropbox/PhD_Thesis/Adaptive_Control/Data/Behavior/All_subjects.csv"
AdapCon <- read.csv(file = filename)
```

## Filter Data 
First we have to create a new variable for items

```{r}
Data <- AdapCon %>%
  as_tibble() %>%
  mutate(number_1 = as.character(number_1))%>%
  mutate(number_2 = as.character(number_2))%>%
  unite('Item', number_1:number_2, remove = FALSE) %>%
  mutate(Item = as_factor(Item)) %>%
  mutate(Item_specific = ifelse(Analysis_type == "main_con" | Analysis_type == "main_incon", 'Item_spec', 'List_wide' )) %>%
  mutate( Congruency_main = ifelse(Analysis_type == "main_con"| Analysis_type == "MC", "M_Congruent", "M_Incongruent")) %>% 
  select(response_time_Keyboard_response, Age, Congruency, Gender, Analysis_type, Exp_group, Subject_identifier, Trl_type, correct_Keyboard_response, Block, Item, Item_specific, Congruency_main) %>%
  dplyr::rename(RT = response_time_Keyboard_response, Subject = Subject_identifier, Correct_A = correct_Keyboard_response) %>%
  mutate(logRT = log10(RT))
```
## Get bias Term

Some participants had large numbers as mainly incongruent, others had small numbers as mainly incongruent. For the analysis of the item specific effect we want this as a separate random factor.
```{r}

# Get an indicator when large items where used for the item specific effect
NewData <- Data %>%
  dplyr::filter(Item_specific == 'Item_spec') %>%
  dplyr::filter(Trl_type == "Inducer") %>%
  group_by(Subject, Analysis_type, Congruency) %>%
                     count(Item) %>%
  dplyr::filter(Congruency != "congruent") %>%
  dplyr::filter(Analysis_type != "main_con") %>%
  mutate(Bias_Big_Nr = ifelse(Item %in% c('6_7', '6_8', '7_9', '8_9'), 1, 0)) %>%
  ungroup()%>%
  select(Subject,Bias_Big_Nr) %>%
  distinct(Subject, Bias_Big_Nr)

# Include new variable in the data set
Data <- inner_join(Data, NewData, by = "Subject")
```

## Descriptives
```{r}
Descriptives_Age <- Data %>%
  group_by(Exp_group) %>%
  summarise(meanAge = mean(Age))

Descriptives_Gender <- Data %>%
  group_by(Exp_group) %>%
  summarize(male = n_distinct(Gender))
# # %>%
#   count(Gender)

Descriptives_Age
# Descriptives_Gender
```



##For the beginning we only work with the data of young participants

```{r}
AC_data <- Data

AC_young <- AC_data %>%
  dplyr::filter(Exp_group == "CY") %>% # only Young
  dplyr::filter(Block != 'practice') %>% # no practice trials
  dplyr::filter(RT > 200, RT < 1600)  %>%# only between 200 and 1600ms
  dplyr::filter(Correct_A == 1) %>%
  dplyr::filter(Trl_type == "Diagnostic")

AC_old <- AC_data %>%
  dplyr::filter(Exp_group == "CO") %>% # only Young
  dplyr::filter(Block != 'practice') %>% # no practice trials
  dplyr::filter(RT > 200, RT < 1600) %>% # only between 200 and 1600ms
  dplyr::filter(Correct_A == 1)%>%
  dplyr::filter(Trl_type == "Diagnostic")

AC_all <- AC_data %>%
  dplyr::filter(Block != 'practice') %>% # no practice trials
  dplyr::filter(RT > 200, RT < 1600) %>% 
  dplyr::filter(Correct_A == 1)%>%
  mutate(congruency_contrast = ifelse(Congruency == "congruent", -0.5, 0.5)) %>%
  mutate(group_contrast = ifelse(Exp_group == "CO", -0.5, 0.5))
  
 unique(AC_all$Item_specific)
# Get unique column values
subject_nrs <- unique(AC_young$Subject)
# get a rand
subset <- sample(subject_nrs, size=length(subject_nrs)/2, replace = FALSE)

AC_y_subset <- AC_young %>%
  dplyr::filter(Subject %in% subset) %>%# only use half the participant data
  #recode the subject numbers so that they make sense
  rowwise() %>%
  dplyr::mutate(Subject_new = match(Subject, subset))  # new Subject indexes from 1:15
```


## Plott Data

```{r}
## ORGANIZE DATA ####
# Accuracy data
data_accuracy_figs = AC_all %>%
                     group_by(Subject, Exp_group, Analysis_type, Congruency) %>%
                     summarise(perc_correct = mean(Correct_A) * 100) %>%
                     ungroup() 


# Accuracy figure
accuracy.plot = ggplot(data_accuracy_figs, aes(x = Exp_group, y = perc_correct,
                                               fill = Congruency)) +
                geom_boxplot() +
                facet_grid( ~Analysis_type) +
                ylim(0, 100) +
                geom_hline(yintercept = 50)
```

## Plot Reaction Times

```{r}
data_meanRT_figs = AC_all %>%
                     group_by(Subject, Exp_group, Analysis_type, Congruency) %>%
                     summarise(mean_RT = mean(RT)) %>%
                     ungroup()
                     



rt_histogram.plot = ggplot(AC_all, aes(x = RT, fill = Congruency)) +
                    geom_histogram(bins = 30) +
                    facet_grid(Exp_group ~ Analysis_type)


ggplot(data_meanRT_figs, aes(y = mean_RT, fill = Congruency)) +
                geom_boxplot() +
                facet_grid(Exp_group ~ Analysis_type) +
                geom_hline(yintercept = 613)

```
## Modelling Reaction Times for young and old

First we prepare the data, excluding incorrect trials
```{r}
RT_listwide <- AC_all %>%
  dplyr::filter(Exp_group != "PD") %>%
  dplyr::filter(Trl_type == "Diagnostic") %>%
  filter(Item_specific == "List_wide") %>%
  mutate(Exp_group = as_factor(Exp_group)) %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type)) 

RT_itemspecific <- AC_all %>%
  dplyr::filter(Exp_group != "PD") %>%
  dplyr::filter(Trl_type == "Diagnostic") %>%
  filter(Item_specific == "Item_spec") %>%
  mutate(Exp_group = as_factor(Exp_group)) %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type)) 


RT_young_itemspecific <- AC_all %>%
  dplyr::filter(Exp_group != "PD") %>%
  dplyr::filter(Trl_type == "Diagnostic") %>%
  filter(Item_specific == "Item_spec") %>%
  filter(Exp_group =="CY") %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type)) 

RT_young_listwide <- AC_all %>%
  dplyr::filter(Exp_group != "PD") %>%
  dplyr::filter(Trl_type == "Diagnostic") %>%
  filter(Item_specific == "List_wide") %>%
  filter(Exp_group =="CY") %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type)) 


SimpleModel_LW_Y <- glmer(RT ~  Analysis_type *Congruency +  (1|Subject) + (1|Item) ,data = RT_young_listwide, family = gaussian(link="identity"))

SimpleModel_IS_Y <- glmer(RT ~  Analysis_type *Congruency +  (1|Subject) + (1|Item) + (1|Bias_Big_Nr),data = RT_young_itemspecific, family = gaussian(link="identity"))

summary(SimpleModel_LW_Y)

summary(SimpleModel_IS_Y)


GaussianModel.RT_LW <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group +  (1|Subject) ,data = RT_listwide, family = gaussian(link="identity"))

GaussianModel.RT_IS <- glmer(RT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group +  (1|Subject) + (1|Item) + (1|Bias_Big_Nr),data = RT_itemspecific, family = gaussian(link="identity"))

#InvGaussianModel.RT_LW <- glmer(RT ~ group_contrast + congruency_contrast + Block_contrast + Block_contrast*congruency_contrast + Block_contrast*congruency_contrast*group_contrast +  (1|Subject) + (1|Item), data = RT_listwide, family = inverse.gaussian(link="identity"))

#InvGaussianModel.RT_IS <- glmer(RT ~ Exp_group + Congruency + Analysis_type + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group +  (1|Subject) + (1|Item),data = RT_itemspecific, family = inverse.gaussian(link="identity"))



summary(GaussianModel.RT_LW)
summary(GaussianModel.RT_IS)

#car::Anova(GaussianModel.RT_LW,type=3)
#car::Anova(GaussianModel.RT_IS,type=3)

#summary(InvGaussianModel.RT)
#library(effects)
#plot(effects::allEffects(SimpleModel))
```
## Modelling Reaction Times for Old and Parkinson for the Listwide Effect

```{r}
RT_listwide <- AC_all %>%
  dplyr::filter(Exp_group != "CY") %>%
  dplyr::filter(Trl_type == "Diagnostics") %>%
  filter(Item_specific == "List_wide") %>%
  mutate(Exp_group = as_factor(Exp_group)) %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type)) 

#simplest model including only the main effects
GM.RT_LW_1 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + (1|Subject) ,data = RT_listwide, family = gaussian(link="identity"))

GM.RT_LW_2 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency +  (1|Subject) + (1|Item),data = RT_listwide, family = gaussian(link="identity"))

anova(GM.RT_LW_1, GM.RT_LW_2, test ="Chisq")

GM.RT_LW_3 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency +   (1|Subject) + (1|Item),data = RT_listwide, family = gaussian(link="identity"))

anova(GM.RT_LW_2, GM.RT_LW_3, test ="Chisq")

GM.RT_LW_4 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group+   (1|Subject) + (1|Item),data = RT_listwide, family = gaussian(link="identity"))


anova(GM.RT_LW_3, GM.RT_LW_4, test ="Chisq")

summary(GM.RT_LW_4 )

car::Anova(GM.RT_LW_4,type=3)
```

## Modelling Reaction Times for Old and Parkinson for the Itemspecific Effect

```{r}
RT_itemspecific <- AC_all %>%
  dplyr::filter(Exp_group != "CY") %>%
  dplyr::filter(Trl_type == "Diagnostic") %>%
  filter(Item_specific == "Item_spec") %>%
  mutate(Exp_group = as_factor(Exp_group)) %>%
  mutate(Subject = as_factor(Subject)) %>%
  mutate(Gender = as_factor(Gender)) %>%
  mutate(Item_specific = as_factor(Item_specific)) %>%
  mutate(Congruency_main = as_factor(Congruency_main)) %>%
  mutate(Analysis_type = as_factor(Analysis_type))


#simplest model including only the main effects
GM.RT_IS_1 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + (1|Subject) ,data = RT_itemspecific, family = gaussian(link="identity"))

#GM.RT_IS_1_inverse <- glmer(RT ~ Exp_group + Analysis_type + Congruency + (1|Subject) ,data = RT_itemspecific, family = inverse.gaussian(link="identity"))

GM.RT_IS_2 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency +  (1|Subject) + (1|Item),data = RT_itemspecific, family = gaussian(link="identity"))

#GM.RT_IS_2_inverse <- glmer(RT ~ Exp_group + Analysis_type + Congruency + (1|Subject) + (1|Item) ,data = RT_itemspecific, family = inverse.gaussian(link="identity"))

#anova(GM.RT_IS_1_inverse, GM.RT_IS_2_inverse, test ="Chisq")

GM.RT_IS_2_5 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency +  (1|Subject) + (1|Item) + (1|Bias_Big_Nr),data = RT_itemspecific, family = gaussian(link="identity"))

anova(GM.RT_IS_2, GM.RT_IS_2_5, test ="Chisq") 
# In conclusion we can say Bias_Big_Nr does not meaningfully improve model fit

GM.RT_IS_3 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency +   (1|Subject) + (1|Item),data = RT_itemspecific, family = gaussian(link="identity"))

#GM.RT_IS_3_inverse <- glmer(RT ~ Exp_group + Analysis_type + Congruency +  Analysis_type*Congruency + (1|Subject) + (1|Item) ,data = RT_itemspecific, family = inverse.gaussian(link="identity"), control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))


#anova(GM.RT_IS_2_inverse, GM.RT_IS_3_inverse, test ="Chisq")

GM.RT_IS_4 <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group+   (1|Subject) + (1|Item),data = RT_itemspecific, family = gaussian(link="identity"))

#GM.RT_IS_4_inverse <- glmer(logRT ~ Exp_group + Analysis_type + Congruency + Analysis_type*Congruency + Analysis_type*Congruency*Exp_group+   (1|Subject) + (1|Item),data = RT_itemspecific, family = inverse.gaussian(link="identity"), control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e6)))



anova(GM.RT_IS_3, GM.RT_IS_4, test ="Chisq")

summary(GM.RT_IS_4 )

car::Anova(GM.RT_IS_4,type=3)

library(parameters)

results <- model_parameters(GM.RT_IS_4,
                            ci = 0.95,
  bootstrap = FALSE,
  iterations = 2e5,
  effects = "all",
  component = "all",
  group_level = FALSE,
  standardize = NULL,
  exponentiate = FALSE,
  ci_method = "wald",
  p_adjust = NULL,
  wb_component = TRUE,
  summary = getOption("parameters_mixed_summary", FALSE),
  keep = NULL,
  drop = NULL,
  parameters = keep,
  verbose = TRUE,
  include_sigma = FALSE)
results
```



# Bayesian Mixed Effects model

Since the frequentist alternative appears not be able converge for the inverse Gaussian Model - we will proceed with the Bayesian Alternative. For the
```{r}
# Test for interaction of congruency x experiment half
accuracy_congruencyxhalf.glmer = glmer(accuracy ~ congruency_contrast * half_contrast -
                                                         congruency_contrast:half_contrast +
                                                  (1|subject_id) +
                                                  (0+half_contrast|subject_id) +
                                                  (1|item), family = "binomial",
                                                  data = data_accuracy_stats)

accuracy_congruencyxhalf.anova = anova(accuracy.glmer, accuracy_congruencyxhalf.glmer)
accuracy_congruencyxhalf.anova
```

